{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Donut - KBP{% endblock %}


{% block content %}
<div class="row" id="app" v-cloak>
    <div class="col-lg-12">
        <div class="row" style="padding-top:15px; padding-bottom: 15px">
            <div class="col-lg-6" style="display:flex;align-items:center; justify-content: center">
                <a v-bind:href="calculatePreviousYear()" class="btn btn-secondary">View Previous Year's Data</a>
            </div>
            <div class="col-lg-6" style="display:flex;justify-content:center;align-items:center;">
                <a v-if="year != currentYear" v-bind:href="calculateNextYear()" class="btn btn-secondary adjust-buttons">View Following Year's Data</a>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12" style="display:flex;justify-content:center;align-items:center;">
                <h1 style="text-align:center">{{year}} Officer Involved Killings</h1>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12" style="display:flex;justify-content:center;align-items:center;">
                <h4 style="text-align:center">{{total}} Killed This Year</h4>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="card border-dark" style="margin-bottom:20px;">
                <div class="card-header">Filters</div>
                <div class="card-body">
                    <form>
                        <div class="form-group row">
                             <div class="col-lg-4">
                                <label for="name_text">Filter by name</label>
                                <input id="name_text" type="text" class="form-control" placeholder="Partial and similar matches will be included." v-model="name">
                            </div>
                           
                            <div class="col-lg-4">
                                <label for="race_select">Filter by race</label>
                                <select id="race_select" class="form-control" style="width:100%" multiple="multiple">
                                    <option></option>
                                    <option v-for="race in races" v-bind:value="race.value">((race.display))</option>
                                </select>
                            </div>
                            <div class="col-lg-4">
                                <label for="tag_select">Filter by tag</label>
                                <select id="tag_select" class="form-control" style="width:100%" multiple="multiple">
                                    <option></option>
                                    <option v-for="tag in all_tags" v-bind:value="tag.value">((tag.display))</option>
                                </select>
                                <small class="text-muted">Killings with 1 or more matches will be displayed</small>
                            </div>
                        </div>
                         <div class="form-group row">
                            <div class="col-lg-4">
                                <label for="state_select">Filter by state</label>
                                <select id="state_select" class="form-control" style="width:100%" multiple="multiple">
                                    <option></option>
                                    <option v-for="state in states" v-bind:value="state.value">((state.display))</option>
                                </select>
                            </div>
                            <div class="col-lg-4">
                                <label for="city_text">Filter by city</label>
                                <input id="city_text" type="text" class="form-control" placeholder="Partial and similar matches will be included." v-model="city">
                            </div>
                            <div class="col-lg-4">
                                <label for="gender_select">Filter by gender</label>
                                <select id="gender_select" class="form-control" style="width:100%" multiple="multiple">
                                    <option></option>
                                    <option v-for="gender in genders" v-bind:value="gender.value">((gender.display))</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-lg-4">
                                <label for="name_text">Killed on or after</label>
                                <div class="input-group date" id="start_date" data-target-input="nearest">
                                    <input type="text" class="form-control datetimepicker-input" data-target="#start_date"/>
                                    <div class="input-group-append" data-target="#start_date" data-toggle="datetimepicker">
                                        <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <label for="name_text">Killed on or before</label>
                                <div class="input-group date" id="end_date" data-target-input="nearest">
                                    <input type="text" class="form-control datetimepicker-input" data-target="#end_date"/>
                                    <div class="input-group-append" data-target="#end_date" data-toggle="datetimepicker">
                                        <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <button type="button" class="btn btn-warning" v-on:click="resetFilters" style="margin-top:30px;">Reset Filters</button>
                            </div>
                        </div>

                    </form>
                </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr style="background-color:white;">
                            <th class="noselect" style="cursor: pointer;" v-on:click="order_by('name')">
                                Name 
                                <i class="fa fa-sort-asc" v-if="order.name == 1" aria-hidden="true"></i>
                                <i class="fa fa-sort-desc" v-if="order.name == -1" aria-hidden="true"></i>
                            </th>
                            <th class="noselect" style="cursor: pointer;" v-on:click="order_by('age')">
                                Age 
                                <i class="fa fa-sort-asc" v-if="order.age == 1" aria-hidden="true"></i>
                                <i class="fa fa-sort-desc" v-if="order.age == -1" aria-hidden="true"></i>
                            </th>
                            <th class="noselect" style="cursor: pointer;" v-on:click="order_by('date')">
                                Date 
                                <i class="fa fa-sort-asc" v-if="order.date == 1" aria-hidden="true"></i>
                                <i class="fa fa-sort-desc" v-if="order.date == -1" aria-hidden="true"></i>
                            </th>
                            <th class="noselect" style="cursor: pointer;" v-on:click="order_by('race')">
                                Race 
                                <i class="fa fa-sort-asc" v-if="order.race == 1" aria-hidden="true"></i>
                                <i class="fa fa-sort-desc" v-if="order.race == -1" aria-hidden="true"></i>
                            </th>
                            <th class="noselect" style="cursor: pointer;" v-on:click="order_by('gender')">
                                Gender 
                                <i class="fa fa-sort-asc" v-if="order.gender == 1" aria-hidden="true"></i>
                                <i class="fa fa-sort-desc" v-if="order.gender == -1" aria-hidden="true"></i>
                            </th>
                            <th class="noselect" style="cursor: pointer;" v-on:click="order_by('state')">
                                State 
                                <i class="fa fa-sort-asc" v-if="order.state == 1" aria-hidden="true"></i>
                                <i class="fa fa-sort-desc" v-if="order.state == -1" aria-hidden="true"></i>
                            </th>
                            <th class="noselect" style="cursor: pointer;" v-on:click="order_by('city')">
                                City 
                                <i class="fa fa-sort-asc" v-if="order.city == 1" aria-hidden="true"></i>
                                <i class="fa fa-sort-desc" v-if="order.city == -1" aria-hidden="true"></i>
                            </th>
                            <th>
                                Tags 
                            </th>
                            <th>
                                Details 
                            </th>
                            {% if user.is_authenticated %}
                            <th>
                                Admin Actions
                            </th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="shooting in displayed_shootings">
                            <td>
                                ((shooting.name))
                            </td>
                            <td>
                                ((displayAge(shooting.age) ))
                            </td>
                            <td>
                                ((shooting.date))
                            </td>
                            <td>
                                ((shooting.race))
                            </td>
                            <td>
                                ((shooting.gender))
                            </td>
                            <td>
                                ((shooting.state))
                            </td>
                            <td>
                                ((shooting.city))
                            </td>
                            <td>
                                <span style="padding: 5px; margin-right: 5px" v-for="tag in shooting.tags" class="badge badge-primary">((tag.text))</span>
                            <td>
                                <button v-on:click="openDetails(shooting.id)" type="button" class="btn btn-sm btn-primary">Details</button>
                            </td>
                            {% if user.is_authenticated %}
                            <td>
                                <button v-on:click="editShooting(shooting.id)" type="button" class="btn btn-sm btn-primary">Edit</button>
                                <button v-on:click="deleteShooting(shooting.id)" type="button" class="btn btn-sm btn-danger"><i style="font-size:16px" class="fa fa-trash fa-2" aria-hidden="true"></i></button>
                            </td>
                            {% endif %}
                        </tr>
                        <tr v-show="shootings.length == 0">
                            {% if user.is_authenticated %}
                            <td colspan="10" style="text-align:center">
                                No shootings yet
                            </td>
                            {% else %}
                            <td colspan="9" style="text-align:center">
                                No shootings yet
                            </td>
                            {% endif %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="modal" id="shooting_details" tabindex="-1" role="dialog" style="overflow-y:scroll">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">((displayed_shooting.name)), ((displayed_shooting.date))</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-12">
                            <h5>Donut's Take</h5>
                            <div v-if="displayed_shooting.video_url != 'None'" v-html="displayed_shooting.video_url"> </div>
                            <div v-else style="background-color:gray; width:100%; height:315px" class="d-flex flex-row    p-2 flex-column justify-content-center flex-fill">
                                <div class="align-self-center p-2"><h1 style="color:white;">No Video Available</h1></div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-lg-12">
                            <h5>Sources</h5>
                            <table class="table table-striped">
                                <tbody>
                                    <tr v-for="source in displayed_shooting.sources">
                                        <td style="max-width: 100px; word-wrap: break-word;"><a v-bind:href="source">((source))</a></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <h5>Further Details</h5>
                            <div style="height: 200px; overflow-y: scroll" v-if="displayed_shooting.description !== undefined && displayed_shooting.description.length != 0"  v-html="displayed_shooting.description">
                                
                            </div>
                            <p style="height:200px; overflow-y:scroll" v-else>No further details at this time.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock content %}

{% block js %}
<script type="text/javascript">
    $(function() {
        setTimeout(function() {
            // loader is on base.html. Blocks the user from doing anything until page loads
            $("#loader_cover").addClass("toggled");
            $("#body").removeAttr("style")
        },2000);
        $("#state_select").select2({
            theme: "bootstrap",
            placeholder: "Select state or states"
        })
        $('#state_select').on("change", function(e) { 
            vue_app.states_selected = $(this).val();
        });
        $("#race_select").select2({
            theme: "bootstrap",
            placeholder: "Select race or races"
        })
        $('#race_select').on("change", function(e) { 
            vue_app.races_selected = $(this).val();
        });
        $("#tag_select").select2({
            theme: "bootstrap",
            placeholder: "Select tag or tags"
        })
        $('#tag_select').on("change", function(e) { 
            vue_app.tags_selected = $(this).val();
        });
        $("#gender_select").select2({
            theme: "bootstrap",
            placeholder: "Select gender or genders"
        })
        $('#gender_select').on("change", function(e) { 
            vue_app.genders_selected = $(this).val();
        });
        $('#start_date').datetimepicker({
            format:"L",
            useCurrent: false,
        });
        $('#end_date').datetimepicker({
            format:"L",
            useCurrent: false,
        });
        $('#start_date').on("change.datetimepicker", function (e) {
            vue_app.start_date = $('#start_date').datetimepicker('viewDate');
        });
        $('#end_date').on("change.datetimepicker", function (e) {
            vue_app.end_date = $('#end_date').datetimepicker('viewDate');
        });
    })
    var vue_app = new Vue({
        el: '#app',
        delimiters: ["((","))"],
        data: {
            order: {
                name: 0,
                age: 0,
                date: 0,
                race: 0,
                gender: 0,
                state: 0,
                city: 0,
            },
            order_attribute: "",
            states_selected: [], // populated by jQuery upon select2 select
            races_selected: [], // populated by jQuery upon select2 select
            tags_selected: [], // populate by jQuery upon select2 select
            genders_selected: [], // populate by jQuery upon select2 select
            start_date: "", // populate by jQuery upon dp.change
            end_date: "", // populate by jQuery upon dp.change
            name: "", // two way binding for filter
            city: "", // two way binding for filter
            displayed_video: "",
            displayed_shooting: {},
            races: [
                {% for race in races %}
                {
                    value: `{{race.0}}`,
                    display: `{{race.1}}`
                },
                {% endfor %}
            ], // used for filling select2
            states: [
                {% for state in states %}
                {
                    value: `{{state.0}}`,
                    display: `{{state.1}}`
                },
                {% endfor %}
            ], // used for filling select2
            genders: [
                {% for gender in genders %}
                {
                    value: `{{gender.0}}`,
                    display: `{{gender.1}}`
                },
                {% endfor %}
            ], // used for filling select2
            all_tags: [
                {% for tag in all_tags %}
                {
                    value: `{{tag.text}}`,
                    display: `{{tag.text}}`
                },
                {% endfor %}
            ], // used for filling select2
            shootings: {{shootings|safe}},
            year: "{{year}}"
        },
        mounted: function() {
            var self = this;
            for (var x = 0; x < self.shootings.length; x++) {
                self.shootings[x].date = self.shootings[x].date.replace("Jan.", "January");
                self.shootings[x].date = self.shootings[x].date.replace("Feb.", "February");
                self.shootings[x].date = self.shootings[x].date.replace("Aug.", "August");
                self.shootings[x].date = self.shootings[x].date.replace("Sept.", "September");
                self.shootings[x].date = self.shootings[x].date.replace("Sep.", "September");
                self.shootings[x].date = self.shootings[x].date.replace("Oct.", "October");
                self.shootings[x].date = self.shootings[x].date.replace("Nov.", "November");
                self.shootings[x].date = self.shootings[x].date.replace("Dec.", "December");
            }
        },
        methods: {
            {% if user.is_authenticated %}
            deleteShooting: function(id) {
                /*Confirms the user's choice then deletes a shooting through AJAX.
                
                Displays a success message and reloads on success, displays error on failure
                
                Expects:
                :param id: the pk of a shooting that will be sent to the backend.
                
                Returns:
                None
                */
                var data = {
                    "id": parseInt(id),
                    "csrfmiddlewaretoken": "{{csrf_token}}",
                }
                $.confirm({
                    type: "red",
                    title: "Are you sure?",
                    content: "This action cannot be undone. Are you sure you want to continue?",
                    buttons: {
                        Yes: function() {
                            $.ajax({
                                type: "POST",
                                url: "{% url 'roster:delete-killing' %}",
                                data: data,
                                success: function() {
                                    $.alert({
                                        title: 'Success!',
                                        content: 'Killing deleted succesfully. The page will now reload.',
                                        type: 'green',
                                        typeAnimated: true,
                                        autoClose: 'close|4000',
                                        buttons: {
                                            close: function () {
                                                window.location.reload()
                                            }
                                        }
                                    });
                                },
                                error: function(data) {
                                    console.log(data)
                                    $.confirm({
                                        title: 'Encountered an error!',
                                        content: 'Something went wrong when processing the request. Send Pedro a text message and save this information: ' + data.responseText,
                                        type: 'red',
                                        typeAnimated: true,
                                        backgroundDismiss: false,
                                        buttons: {
                                            close: function () {
                                            }
                                        }
                                    });
                                },
                            });
                        },
                        Cancel: function() {

                        }
                    }
                })
            },
            editShooting: function(id) {
                /*Chooses the shooting to be edited and passes the data to the nav_app

                The nav_app is in charge of all editing, so we just need to pass the data to the nav_app.
                We start by iterating through the killings until we find the one who's id matches the argument
                passed.

                We then begin populating an array with the tags since passing the tags directly for some reason
                results in null (suspect it has something to do with variable lifespan and javascript passing by reference
                and not by value for object as opposed to basic valuesbut this solves the problem so
                not worth checking). We then assign the nav_app shooting to match the details of the current shooting
                and set the creating flag to false, which means the nav_app will submit the details to the edit endpoint
                instead of the creation endpoint.

                We then call the openKillingModal function of nav_app, which will populate the modal's non-2-way-bound
                form fields with jQuery and open the editing modal.

                Arguments:
                :param id: an integer id

                Returns:
                Nothing
                */
                for (var x = 0; x < this.shootings.length; x++) {
                    if (this.shootings[x].id == id) {
                        tags = []
                        for (var y = 0; y < this.shootings[x].tags.length; y++) {
                            tags.push(this.shootings[x].tags[y].text)
                        }
                        nav_app.shooting.id = this.shootings[x].id
                        nav_app.shooting.name = this.shootings[x].name
                        nav_app.shooting.date = this.shootings[x].date
                        nav_app.shooting.race = this.shootings[x].race_value
                        nav_app.shooting.age = this.shootings[x].age
                        nav_app.shooting.gender = this.shootings[x].gender_value
                        nav_app.shooting.state = this.shootings[x].state_value
                        nav_app.shooting.city = this.shootings[x].city
                        if (this.shootings[x].unfiltered_video_url == "None") {
                            nav_app.shooting.video_url = ""
                        }
                        else {
                            nav_app.shooting.video_url = this.shootings[x].unfiltered_video_url
                        }
                        if (this.shootings[x].age == -1) {
                            nav_app.shooting.age = "";
                        }
                        nav_app.shooting.sources = this.shootings[x].sources
                        nav_app.shooting.description = this.shootings[x].description
                        nav_app.shooting.tags = tags

                        nav_app.creating = false;
                        nav_app.openKillingModal();
                        return;
                    }
                }
            },
            {% endif %}
            order_by: function(attribute) {
                /*Sets the order object that is used in the computed function for displaying killings
					
                Given the attribute, we set that attribute to 1 if it is -1 or 0, or -1 if it is set to 1,
                and sets all other attributes to 0.

                Arguments:
                :param attribute: a string of a key
                */
                var self = this;
                this.order_attribute = attribute;
                $.each(self.order, function(key, value) {
                    if (key == attribute) {
                        if (self.order[attribute] == 0) {
                            self.order[attribute] = 1;
                        }
                        else if (self.order[attribute] == 1) {
                            self.order[attribute] = -1;
                        }
                        else {
                            self.order[attribute] = 1;
                        }
                    }
                    else {
                        self.order[key] = 0;
                    }
                });
            },
            resetFilters: function() {
                /*Resets the filter choices
					
                Sets 2-way-bound variables to their default values, and uses jQuery to reset non-2-way-bound variables

                Arguments:
                None

                Returns:
                None
                */
                var self = this;
                self.order_attribute = "";
                $.each(self.order, function(key, value) {
                    self.order[key] = 0;
                });
                $("#state_select").val([]).trigger("change")
                $("#race_select").val([]).trigger("change")
                $("#tag_select").val([]).trigger("change")
                $("#gender_select").val([]).trigger("change");
                this.name = "";
                this.city = "";
                this.states_selected = [];
                this.genders_selected = [];
                this.races_selected = [];
                this.tags_selected = [];
                this.start_date = "";
                this.end_date = "";
                $('#start_date').datetimepicker('clear');
                $('#end_date').datetimepicker('clear');
            },
            calculateNextYear: function() {
                /*Calculates the next year for setting the url of the Next Year button
					
                Uses the year passed from the server (which is the year currently being viewed) to
                decide which year is next

                Arguments:
                None

                Returns:
                None
                */
                var year = moment("{{year}}", "YYYY").add(1, "y").format("YYYY")
                var url = "{% url 'roster:date-index' date=1234 %}";
                url = url.replace("1234", year);
                return url;
            },
            calculatePreviousYear: function() {
                /*Calculates the previous year for setting the url of the Previous Year button
					
                Uses the year passed from the server (which is the year currently being viewed) to
                decide which year is past

                Arguments:
                None

                Returns:
                None
                */
                var year = moment("{{year}}", "YYYY").subtract(1, "y").format("YYYY")  
                var url = "{% url 'roster:date-index' date=1234 %}";
                url = url.replace("1234", year);
                return url;
            },
            openDetails: function(id) {
                /*Opens the details modal for a killing who's id matches the passed argument
                
                Iterates through killings to find the killing with the id that matches, and sets the
                displayed_shooting two way bound variable to that shooting so that it is autopopulated into the
                details modal, then opens the details modal
                
                Argument:
                :param id: the pk of a killing to be displayed
                
                Returns:
                None
                */
                shooting = this.shootings.find(function(shooting) {
                    return shooting.id == id
                })
                this.displayed_shooting = shooting
                $('#shooting_details').modal('toggle');
            },
            displayAge: function(age) {
                /*Handles displaying age to avoid displaying -1
                
                Arguments:
                :param age: integer from -1 - positive infinity
                
                Returns:
                If age < 0, returns "No Age"
                else returns age
                */
                if (age > -1) {
                    return age
                }
                else {
                    return "No Age"
                }
            }
        },
        computed: {
            currentYear: function() {
                /*Selects the current year
					
                This is used for deciding whether to display the "Next Year" button, which shouldn't be displayed for
                accessing a future years

                Arguments:
                None

                Returns:
                current year as "YYYY"

                */
                return moment().format("YYYY")
            },
            displayed_shootings: function() {
                /*Calculates what shootings should be displayed to the user and returns the valid shootings
					
                Copies the list of shootings (so we don't affect the list)
                Filters by text, then city, then states, then genders, then races of the shooting,
                then tags, then start date, then end date, then orders them by the order attribute
                */
                var self = this;
                var displayed_shootings = this.shootings.slice();
                if (this.name.length > 0) {
                    displayed_shootings = displayed_shootings.filter(function(shooting) {
                        if (shooting.name.toUpperCase().indexOf(self.name.toUpperCase()) > -1) {
                            return true;
                        } 
                    })
                }
                if (this.city.length > 0) {
                    displayed_shootings = displayed_shootings.filter(function(shooting) {
                        if (shooting.city.toUpperCase().indexOf(self.city.toUpperCase()) > -1) {
                            return true;
                        } 
                    })
                }
                if (this.states_selected.length > 0) {
                    displayed_shootings = displayed_shootings.filter(function(shooting) {
                        if (self.states_selected.indexOf("" + shooting.state_value) > -1) {
                            return true;
                        }
                    })
                }
                if (this.genders_selected.length > 0) {
                    displayed_shootings = displayed_shootings.filter(function(shooting) {
                        if (self.genders_selected.indexOf("" + shooting.gender_value) > -1) {
                            return true;
                        }
                    })
                }
                if (this.races_selected.length > 0) {
                    displayed_shootings = displayed_shootings.filter(function(shooting) {
                        if (self.races_selected.indexOf("" + shooting.race_value) > -1) {
                            return true;
                        }
                    })
                }
                if (this.tags_selected.length > 0) {
                    displayed_shootings = displayed_shootings.filter(function(shooting) {
                        for (var y = 0; y < shooting.tags.length; y++) {
                            if (self.tags_selected.indexOf("" + shooting.tags[y].text) > -1) {
                                return true;
                            }
                        }
                    })
                }
                if (this.start_date.length != 0) {
                    displayed_shootings = displayed_shootings.filter(function(shooting) {
                        var date = moment(shooting.date, "YYYY-MM-DD");
                        if (self.start_date < date) {
                            return true;
                        }
                    })
                }
                if (this.end_date.length != 0) {
                    displayed_shootings = displayed_shootings.filter(function(shooting) {
                        var date = moment(shooting.date, "YYYY-MM-DD");
                        if (self.end_date > date) {
                            return true;
                        }
                    })
                }
                if (self.order_attribute != "") {
                    order_order = self.order[self.order_attribute]; // 1 for ascending, -1 for descending
                    if (order_order == 1) {
                        displayed_shootings.sort(function(a , b) {
                            if (self.order_attribute == "date") {
                                if (moment(a[self.order_attribute], "YYYY-MM-DD").isBefore(moment(b[self.order_attribute], "YYYY-MM-DD"))) {
                                    return 1;
                                }
                                else if (moment(b[self.order_attribute], "YYYY-MM-DD").isBefore(moment(a[self.order_attribute], "YYYY-MM-DD"))) {
                                    return -1;
                                }
                                return 0
                            }
                            else {
                                return a[self.order_attribute].localeCompare(b[self.order_attribute])
                            }
                        })
                    }
                    else {
                        displayed_shootings.sort(function(a , b) {
                            if (self.order_attribute == "date") {
                                if (moment(a[self.order_attribute], "YYYY-MM-DD").isBefore(moment(b[self.order_attribute], "YYYY-MM-DD"))) {
                                    return -1;
                                }
                                else if (moment(b[self.order_attribute], "YYYY-MM-DD").isBefore(moment(a[self.order_attribute], "YYYY-MM-DD"))) {
                                    return 1;
                                }
                                return 0
                            }
                            else {
                                return b[self.order_attribute].localeCompare(a[self.order_attribute])
                            }
                        })
                    }
                }
                return displayed_shootings
            }
        }
    })
</script>
{% endblock %}
